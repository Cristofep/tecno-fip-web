---
import Layout from "../../layouts/Layout.astro";
import Menu from "../../components/Menu.astro";
import { supabase } from '../../../public/lib/supabase';

// Verifica si el método es POST (formulario de login)
if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const correo = formData.get('email');
  const password = formData.get('password');

  // Consulta la base de datos para obtener el id del usuario
  const { data, error } = await supabase
    .from('usuario')
    .select('id, nombre')
    .eq('correo', correo)
    .eq('password', password)
    .single();

  if (data && !error) {
    const userId = data.id;
    const username = data.nombre;
    return Astro.redirect(`/auth/login?setStorage=true&id=${userId}&nombre=${encodeURIComponent(username)}`);
  } else {
    // Si hay un error o el usuario no existe
    return Astro.redirect('/auth/login'); // O muestra un mensaje de error
  }
}
---

<Layout title="Iniciar Sesión">
  <Menu/>
  <div class="flex items-center justify-center min-h-screen p-4 bg-gradient-to-r from-indigo-800 to-blue-900">
    <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full animate-fade-in">
      <h2 class="text-2xl font-bold text-center text-indigo-800 mb-8">Iniciar Sesión</h2>

      <form method="POST" class="space-y-6" novalidate>
        <div>
          <label for="email" class="block text-indigo-900 font-semibold mb-2">Correo Electrónico</label>
          <input
            type="email"
            id="email"
            name="email"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-800 transition-all duration-300"
            placeholder="Introduce tu correo electrónico"
            required
          />
        </div>

        <div>
          <label for="password" class="block text-indigo-900 font-semibold mb-2">Contraseña</label>
          <input
            type="password"
            id="password"
            name="password"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-800 transition-all duration-300"
            placeholder="Introduce tu contraseña"
            required
          />
        </div>

        <button
          type="submit"
          class="w-full bg-indigo-800 text-white py-3 rounded-lg font-semibold hover:bg-blue-900 focus:outline-none focus:ring-2 focus:ring-indigo-800 focus:ring-offset-2 transition-all duration-300 transform hover:scale-105"
        >
          Iniciar Sesión
        </button>
      </form>

      <p class="text-center text-gray-600 mt-6">
        ¿No tienes una cuenta?
        <a href="/auth/register" class="text-indigo-800 font-semibold hover:text-blue-900 transition-colors duration-300">Regístrate</a>
      </p>
    </div>
  </div>

  <style>
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in {
      animation: fadeIn 0.5s ease-out forwards;
    }
  </style>
  <script is:client="load">
    const params = new URLSearchParams(window.location.search);
  
    if (params.get("setStorage") === "true") {
      const userId = params.get("id");
      const username = params.get("nombre");
  
      if (userId && username) {
        localStorage.setItem("usuario_id", userId);
        localStorage.setItem("nombre_usuario", username);
  
        // Limpiar la URL y redirigir al panel
        window.location.replace(`/usuario/${userId}`);
      }
    }
  </script>
  
</Layout>