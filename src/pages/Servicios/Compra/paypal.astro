---
import { supabase } from '../../../../public/lib/supabase';
import Layout from '../../../layouts/Layout.astro';
import Menu from '../../../components/Menu.astro';

const url = new URL(Astro.request.url);
const id = url.searchParams.get('id');

let servicio = null;
let errorMessage = null;

try {
  const { data, error } = await supabase
    .from('planes_servicios')
    .select('nombre_servicio, plan, precio, incluye')
    .eq('id', id)
    .single();

  if (error) throw error;

  servicio = data;
} catch (error) {
  errorMessage = error.message;
}
---

<Layout title="Pago con PayPal">
  <Menu />

  <div class="container mx-auto p-4 bg-white shadow-lg rounded-lg max-w-lg mt-6">
    <h1 class="text-2xl font-semibold text-center text-gray-800 mb-6">Pago con PayPal</h1>

    {errorMessage ? (
      <p class="text-red-600 text-center">{`Error al cargar los datos: ${errorMessage}`}</p>
    ) : servicio ? (
      <div class="text-gray-700 space-y-4">
        <p><strong>Servicio:</strong> {servicio.nombre_servicio}</p>
        <p><strong>Plan:</strong> {servicio.plan}</p>
        <p class="text-lg font-bold text-gray-900"><strong>Precio:</strong> ${servicio.precio}</p>

        <div class="mt-6 p-4 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 rounded">
          Serás redirigido a PayPal para completar tu pago de forma segura.
        </div>

        <div class="mt-6 flex justify-end">
          <button id="btn-paypal" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
            Proceder a PayPal
          </button>
        </div>
      </div>
    ) : (
      <p class="text-center">Cargando información del servicio...</p>
    )}
  </div>

  <script type="module" is:inline>
    import { supabase } from '../../../../public/lib/supabase';

    const btnPaypal = document.getElementById('btn-paypal');
    const urlParams = new URLSearchParams(window.location.search);
    const id = urlParams.get('id');

    function generarNumeroPago() {
      const fecha = new Date();
      const yyyymmdd = fecha.toISOString().slice(0, 10).replace(/-/g, '');
      const random = Math.floor(Math.random() * 900 + 100);
      return `${yyyymmdd}${random}`;
    }
    btnPaypal.addEventListener('click', async () => {
      const usuario_id = localStorage.getItem("usuario_id");

    if (!usuario_id) {
      alert("No se encontró el usuario. Por favor, inicia sesión.");
      return;
    }
  
    const { data: usuario, error: errorUsuario } = await supabase
      .from('usuario')
      .select('nombre, correo')
      .eq('id', usuario_id)
      .single();
  
    if (errorUsuario) {
      alert("Error al obtener datos del usuario: " + errorUsuario.message);
      return;
    }
  
    const { data: servicio, error: errorServicio } = await supabase
      .from('planes_servicios')
      .select('nombre_servicio, plan, precio, incluye')
      .eq('id', id)
      .single();
  
    if (errorServicio) {
      alert("Error al obtener datos del servicio: " + errorServicio.message);
      return;
    }
  
    const numero_pago = generarNumeroPago();
  
    // Convertir el campo 'incluye' en un array si es una cadena separada por comas
    const incluyeArray = typeof servicio.incluye === 'string' ? servicio.incluye.split(',').map(item => item.trim()) : servicio.incluye;
  
    const { error: insertError } = await supabase.from('comprobante_pago').insert({
      numero_pago,
      cliente_nombre: usuario.nombre,
      cliente_correo: usuario.correo,
      nombre_servicio: servicio.nombre_servicio,
      plan: servicio.plan,
      incluye: incluyeArray,  // Aquí pasamos el array correctamente
      precio: servicio.precio,
      metodo_pago: "PayPal",
      usuario_id,
    });
  
    if (insertError) {
      alert("Error al guardar el comprobante: " + insertError.message);
      return;
    }
  
    alert("¡Pago registrado con éxito! Serás redirigido a PayPal.");
  
    // Simula redirección a PayPal (reemplaza por tu enlace real)
    window.location.href = `/Servicios/Compra/pago_realizado?numero_pago=${numero_pago}`;
    });
  </script>
</Layout>
